<!DOCTYPE html>
<html lang="zh-cn">
        <head>
                        <meta charset="utf-8" />
                        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                        <meta name="generator" content="Pelican" />
                        <title>一枝红杏出墙来 - BI</title>
                        <link rel="stylesheet" href="https://blog.yinxianwei.com/theme/css/main.css" />
                                <link rel="stylesheet" href="/custom.css" />
        </head>

        <body id="index" class="home">
    <a href="https://github.com/yinxianwei">
            <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />
    </a>
                <header id="banner" class="body">
                        <h1><a href="https://blog.yinxianwei.com/">一枝红杏出墙来</a></h1>
                        <nav><ul>
                                        <li><a href="/">首页</a></li>
                                        <li><a href="/categories.html">分类</a></li>
                                        <li><a href="/tags.html">标签</a></li>
                                        <li><a href="/archives.html">归档</a></li>
                        </ul></nav>
                </header><!-- /#banner -->

                <aside id="featured" class="body">
                    <article>
                        <h1 class="entry-title"><a href="https://blog.yinxianwei.com/shi-yong-dockerbu-shu-superset.html">使用docker部署superset</a></h1>
<footer class="post-info">
        <abbr class="published" title="2023-12-13T17:32:44+08:00">
                Published: Wed 13 December 2023
        </abbr>

                <address class="vcard author">
                        By                                 <a class="url fn" href="https://blog.yinxianwei.com/author/yinxianwei.html">yinxianwei</a>
                </address>
        <p>In <a href="https://blog.yinxianwei.com/category/sui-bi.html">随笔</a>.</p>
<p>tags: <a href="https://blog.yinxianwei.com/tag/bi.html">BI</a> <a href="https://blog.yinxianwei.com/tag/superset.html">superset</a> <a href="https://blog.yinxianwei.com/tag/docker.html">docker</a> </p>        
</footer><!-- /.post-info --><div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/apache/superset.git

<span class="nb">cd</span><span class="w"> </span>superset

docker<span class="w"> </span>compose<span class="w"> </span>up

docker<span class="w"> </span>compose<span class="w"> </span>-f<span class="w"> </span>docker-compose-non-dev.yml<span class="w"> </span>pull
docker<span class="w"> </span>compose<span class="w"> </span>-f<span class="w"> </span>docker-compose-non-dev.yml<span class="w"> </span>up

open<span class="w"> </span>http://localhost:8088
</code></pre></div>

<blockquote>
<p>如何添加superset_config.py文件 <br>
https://github.com/apache/superset/tree/master/docker#readme</p>
</blockquote>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>cp<span class="w"> </span>superset_config.py<span class="w"> </span>superset_app:/app/pythonpath
docker<span class="w"> </span>restart<span class="w"> </span>superset_app
</code></pre></div>

<h2>多语言</h2>
<div class="highlight"><pre><span></span><code><span class="c1"># /app/pythonpath/superset_config.py</span>

<span class="c1"># 多语言</span>
<span class="nv">LANGUAGES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s1">&#39;en&#39;</span>:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;flag&#39;</span>:<span class="w"> </span><span class="s1">&#39;us&#39;</span>,<span class="w"> </span><span class="s1">&#39;name&#39;</span>:<span class="w"> </span><span class="s1">&#39;English&#39;</span><span class="o">}</span>,
<span class="w">    </span><span class="s2">&quot;zh&quot;</span>:<span class="w"> </span><span class="o">{</span><span class="s2">&quot;flag&quot;</span>:<span class="w"> </span><span class="s2">&quot;cn&quot;</span>,<span class="w"> </span><span class="s2">&quot;name&quot;</span>:<span class="w"> </span><span class="s2">&quot;Chinese&quot;</span><span class="o">}</span>,
<span class="o">}</span>
</code></pre></div>

<h2>开启sql模板</h2>
<div class="highlight"><pre><span></span><code><span class="c1"># /app/pythonpath/superset_config.py</span>

<span class="c1"># sql模版 https://superset.apache.org/docs/installation/sql-templating</span>
<span class="nv">FEATURE_FLAGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s1">&#39;ENABLE_TEMPLATE_PROCESSING&#39;</span>:<span class="w"> </span>True
<span class="o">}</span>
</code></pre></div>

<h2>仅LDAP登录</h2>
<blockquote>
<p>https://medium.com/@ozan/configure-ldap-and-local-user-login-on-superset-69fa4df4ee24</p>
</blockquote>
<div class="highlight"><pre><span></span><code>apt<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>libldap2-dev
pip<span class="w"> </span>install<span class="w"> </span>python-ldap
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># /app/pythonpath/superset_config.py</span>

from<span class="w"> </span>flask_appbuilder.security.manager<span class="w"> </span>import<span class="w"> </span>AUTH_DB,AUTH_LDAP

<span class="nv">AUTH_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>AUTH_LDAP<span class="w"> </span>
<span class="nv">AUTH_USER_REGISTRATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>True
<span class="nv">AUTH_USER_REGISTRATION_ROLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Public&quot;</span><span class="w"> </span>
<span class="nv">AUTH_LDAP_SERVER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ldaps://server.yourdomain.com:636&quot;</span>
<span class="nv">AUTH_LDAP_USE_TLS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>False
<span class="nv">AUTH_LDAP_BIND_USER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;CN=Surname\, Name,OU=ouSystemAccounts,DC=yourdomain,DC=com&quot;</span>
<span class="nv">AUTH_LDAP_BIND_PASSWORD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;password&quot;</span>
<span class="nv">AUTH_LDAP_SEARCH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;DC=your_domain,DC=com,DC=tr&quot;</span>
<span class="nv">AUTH_LDAP_UID_FIELD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sAMAccountName&quot;</span>
<span class="nv">AUTH_LDAP_ALLOW_SELF_SIGNED</span><span class="o">=</span>True
<span class="nv">AUTH_LDAP_APPEND_DOMAIN</span><span class="o">=</span>False
<span class="nv">AUTH_LDAP_FIRSTNAME_FIELD</span><span class="o">=</span><span class="s2">&quot;givenName&quot;</span>
<span class="nv">AUTH_LDAP_LASTNAME_FIELD</span><span class="o">=</span><span class="s2">&quot;sn&quot;</span>
<span class="nv">AUTH_LDAP_USE_TLS</span><span class="o">=</span>False
<span class="nv">AUTH_USER_REGISTRATION</span><span class="o">=</span>True
</code></pre></div>

<h2>同时LDAP和本地登录</h2>
<div class="highlight"><pre><span></span><code><span class="c1"># /app/pythonpath/custom_security_manager.py</span>

from<span class="w"> </span>superset.security<span class="w"> </span>import<span class="w"> </span>SupersetSecurityManager
from<span class="w"> </span>flask_appbuilder.security.views<span class="w"> </span>import<span class="w"> </span>AuthLDAPView
from<span class="w"> </span>flask_appbuilder.security.views<span class="w"> </span>import<span class="w"> </span>expose
from<span class="w"> </span>flask<span class="w"> </span>import<span class="w"> </span>g,<span class="w"> </span>redirect,<span class="w"> </span>flash
from<span class="w"> </span>flask_appbuilder.security.forms<span class="w"> </span>import<span class="w"> </span>LoginForm_db
from<span class="w"> </span>flask_login<span class="w"> </span>import<span class="w"> </span>login_user
from<span class="w"> </span>flask_appbuilder._compat<span class="w"> </span>import<span class="w"> </span>as_unicode

class<span class="w"> </span>AuthLocalAndLDAPView<span class="o">(</span>AuthLDAPView<span class="o">)</span>:
<span class="w">    </span>@expose<span class="o">(</span><span class="s2">&quot;/login/&quot;</span>,<span class="w"> </span><span class="nv">methods</span><span class="o">=[</span><span class="s2">&quot;GET&quot;</span>,<span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="o">])</span>
<span class="w">    </span>def<span class="w"> </span>login<span class="o">(</span>self<span class="o">)</span>:
<span class="w">        </span><span class="k">if</span><span class="w"> </span>g.user<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>None<span class="w"> </span>and<span class="w"> </span>g.user.is_authenticated:
<span class="w">            </span><span class="k">return</span><span class="w"> </span>redirect<span class="o">(</span>self.appbuilder.get_url_for_index<span class="o">)</span>
<span class="w">        </span><span class="nv">form</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>LoginForm_db<span class="o">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span>form.validate_on_submit<span class="o">()</span>:
<span class="w">            </span><span class="nv">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>self.appbuilder.sm.auth_user_ldap<span class="o">(</span>
<span class="w">                </span>form.username.data,<span class="w"> </span>form.password.data
<span class="w">            </span><span class="o">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span>not<span class="w"> </span>user:
<span class="w">                </span><span class="nv">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>self.appbuilder.sm.auth_user_db<span class="o">(</span>
<span class="w">                    </span>form.username.data,<span class="w"> </span>form.password.data
<span class="w">                </span><span class="o">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span>user:
<span class="w">                </span>login_user<span class="o">(</span>user,<span class="w"> </span><span class="nv">remember</span><span class="o">=</span>False<span class="o">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span>redirect<span class="o">(</span>self.appbuilder.get_url_for_index<span class="o">)</span>
<span class="w">            </span><span class="k">else</span>:
<span class="w">                </span>flash<span class="o">(</span>as_unicode<span class="o">(</span>self.invalid_login_message<span class="o">)</span>,<span class="w"> </span><span class="s2">&quot;warning&quot;</span><span class="o">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span>redirect<span class="o">(</span>self.appbuilder.get_url_for_login<span class="o">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span>self.render_template<span class="o">(</span>
<span class="w">            </span>self.login_template,<span class="w"> </span><span class="nv">title</span><span class="o">=</span>self.title,<span class="w"> </span><span class="nv">form</span><span class="o">=</span>form,<span class="w"> </span><span class="nv">appbuilder</span><span class="o">=</span>self.appbuilder
<span class="w">        </span><span class="o">)</span>


class<span class="w"> </span>CustomSecurityManager<span class="o">(</span>SupersetSecurityManager<span class="o">)</span>:
<span class="w">    </span><span class="nv">authldapview</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>AuthLocalAndLDAPView
<span class="w">    </span>def<span class="w"> </span>__init__<span class="o">(</span>self,<span class="w"> </span>appbuilder<span class="o">)</span>:
<span class="w">        </span>super<span class="o">(</span>CustomSecurityManager,<span class="w"> </span>self<span class="o">)</span>.__init__<span class="o">(</span>appbuilder<span class="o">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># /app/pythonpath/superset_config.py</span>

import<span class="w"> </span>os
from<span class="w"> </span>superset.security<span class="w"> </span>import<span class="w"> </span>SupersetSecurityManager
from<span class="w"> </span>flask_appbuilder.security.manager<span class="w"> </span>import<span class="w"> </span>AUTH_DB,AUTH_LDAP
from<span class="w"> </span>custom_security_manager<span class="w"> </span>import<span class="w"> </span>CustomSecurityManager

<span class="nv">AUTH_TYPE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>AUTH_LDAP<span class="w"> </span>
<span class="nv">AUTH_USER_REGISTRATION</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>True
<span class="nv">AUTH_USER_REGISTRATION_ROLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Public&quot;</span><span class="w"> </span>
<span class="nv">AUTH_LDAP_SERVER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ldaps://server.yourdomain.com:636&quot;</span>
<span class="nv">AUTH_LDAP_USE_TLS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>False
<span class="nv">AUTH_LDAP_BIND_USER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;CN=Surname\, Name,OU=ouSystemAccounts,DC=yourdomain,DC=com&quot;</span>
<span class="nv">AUTH_LDAP_BIND_PASSWORD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;password&quot;</span>
<span class="nv">AUTH_LDAP_SEARCH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;DC=your_domain,DC=com,DC=tr&quot;</span>
<span class="nv">AUTH_LDAP_UID_FIELD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sAMAccountName&quot;</span>
<span class="nv">AUTH_LDAP_ALLOW_SELF_SIGNED</span><span class="o">=</span>True
<span class="nv">AUTH_LDAP_APPEND_DOMAIN</span><span class="o">=</span>False
<span class="nv">AUTH_LDAP_FIRSTNAME_FIELD</span><span class="o">=</span><span class="s2">&quot;givenName&quot;</span>
<span class="nv">AUTH_LDAP_LASTNAME_FIELD</span><span class="o">=</span><span class="s2">&quot;sn&quot;</span>
<span class="nv">AUTH_LDAP_USE_TLS</span><span class="o">=</span>False
<span class="nv">AUTH_USER_REGISTRATION</span><span class="o">=</span>True

<span class="nv">CUSTOM_SECURITY_MANAGER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>CustomSecurityManager
</code></pre></div>

<h2>rest api 登录</h2>
<div class="highlight"><pre><span></span><code><span class="c1"># /app/pythonpath/superset_config.py</span>

<span class="nv">AUTH_API_LOGIN_ALLOW_MULTIPLE_PROVIDERS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>True
</code></pre></div><p>There are <a href="https://blog.yinxianwei.com/shi-yong-dockerbu-shu-superset.html#disqus_thread">comments</a>.</p>                    </article>
                </aside><!-- /#featured -->
                <section id="extras" class="body">
                                <div class="blogroll">
                                        <h2>links</h2>
                                        <ul>
                                                        <li><a href="https://getpelican.com/">Pelican</a></li>
                                        </ul>
                                </div><!-- /.blogroll -->
                </section><!-- /#extras -->

                <footer id="contentinfo" class="body">
                        <address id="about" class="vcard body">
                                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                        </address><!-- /#about -->

                        <p>The theme is by <a rel="nofollow" href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
                </footer><!-- /#contentinfo -->

    
    <script>
        var link = document.createElement('a')
        link.style.marginRight = "10px"
        link.href = "https://beian.miit.gov.cn"
        link.target = "_blank"
        link.textContent = "豫ICP备16018939号-2"
        document.querySelector('#contentinfo > p').prepend(link)
    </script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J8HMB6HPES"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-J8HMB6HPES');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1314323945395441"
     crossorigin="anonymous"></script>
    <script defer src="https://cloud.umami.is/script.js" data-website-id="084e9ce4-c530-4851-8c0f-c4dd40fb0655"></script>

    <script type="text/javascript">
        var disqus_shortname = 'yinxianwei';
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
        </body>
</html>